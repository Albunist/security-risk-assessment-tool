/*----------------------------------------------------------------------------
*
*     Copyright Â© 2022 THALES. All Rights Reserved.
 *
* -----------------------------------------------------------------------------
* THALES MAKES NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF
* THE SOFTWARE, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED
 * TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 * PARTICULAR PURPOSE, OR NON-INFRINGEMENT. THALES SHALL NOT BE
 * LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING,
 * MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES.
*
* THIS SOFTWARE IS NOT DESIGNED OR INTENDED FOR USE OR RESALE AS ON-LINE
* CONTROL EQUIPMENT IN HAZARDOUS ENVIRONMENTS REQUIRING FAIL-SAFE
* PERFORMANCE, SUCH AS IN THE OPERATION OF NUCLEAR FACILITIES, AIRCRAFT
* NAVIGATION OR COMMUNICATION SYSTEMS, AIR TRAFFIC CONTROL, DIRECT LIFE
* SUPPORT MACHINES, OR WEAPONS SYSTEMS, IN WHICH THE FAILURE OF THE
* SOFTWARE COULD LEAD DIRECTLY TO DEATH, PERSONAL INJURY, OR SEVERE
* PHYSICAL OR ENVIRONMENTAL DAMAGE ("HIGH RISK ACTIVITIES"). THALES
* SPECIFICALLY DISCLAIMS ANY EXPRESS OR IMPLIED WARRANTY OF FITNESS FOR
* HIGH RISK ACTIVITIES.
* -----------------------------------------------------------------------------
*/
const {
    dialog,
} = require('electron');  
const Vulnerability = require('./vulnerability');

/**
  * add default risk row
  * @param {ISRAProject} israProject current ISRA Project
*/
const addVulnerability = (israProject) =>{
    try {
        const vulnerability = new Vulnerability();
        israProject.addVulnerability(vulnerability);
        return [vulnerability.properties];
    } catch (err) {
        return dialog.showMessageBoxSync(null, { message: 'Failed to add Vulnerability' });
    }
};

/**
  * delete selected risk row(s)
  * @param {ISRAProject} israProject current ISRA Project
  * @param {Array} ids of risk id(s)
*/
const deleteVulnerability = (israProject, ids) => {
    try {
        ids.forEach((id) => {
            israProject.deleteVulnerability(Number(id));
        });
    } catch (err) {
      dialog.showMessageBoxSync(null, { message: 'Failed to delete vulnerability(ies)' });
    }
};


const vulnerabilityErrorMsg = require('../../schema/json-schema').properties.Vulnerability.items.properties.cveScore.errorMessage;
const updateVulnerability = (israProject, win, id, field, value) =>{
    try {
        const vulnerability = israProject.getVulnerability(id);

        const calculateOverallLevel = (overallScore) => {
            if (overallScore < 4) vulnerability.overallLevel = 'Low';
            else if (overallScore >= 4 && overallScore < 7) vulnerability.overallLevel = 'Medium';
            else if (overallScore >=7 && overallScore <= 10) vulnerability.overallLevel = 'High';
            else dialog.showMessageBoxSync(null, { type: 'error', title: 'Invalid CVE Score', message: vulnerabilityErrorMsg });
        }

        const calculateOverallScore = (cveScore) =>{
            vulnerability.overallScore = Math.round(cveScore);
            calculateOverallLevel(cveScore);
        }

        if (field === 'addSupportingAssetRef') vulnerability.addSupportingAssetRef(Number(value));
        else if (field === 'deleteSupportingAssetRef') vulnerability.deleteSupportingAssetRef(Number(value));
        else if (field === 'cveScore') {
            if(!Number(value)) value = 0;
            // value = Number(Number(value).toFixed(1));
            vulnerability[field] = Number(value);
            calculateOverallScore(value);
        }
        else vulnerability[field] = value;

        return vulnerability.properties;
    } catch (err) {
        dialog.showMessageBoxSync(null, { message: `Failed to update vulnerability ${id}`});
    }
};

module.exports = {
    addVulnerability,
    deleteVulnerability,
    updateVulnerability
};